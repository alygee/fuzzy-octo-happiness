# Диагностика 403 ошибки при отправке формы OrderForm

## Шаги для диагностики

### 1. Включите режим отладки WordPress

Добавьте в файл `wp-config.php`:
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);
```

### 2. Проверьте логи

После попытки отправки формы проверьте файл:
```
wp-content/debug.log
```

Ищите записи с префиксом `[ERROR]` и `[INFO]`, связанные с:
- `AJAX запрос получен`
- `ОШИБКА NONCE`
- `Создан nonce для AJAX`

### 3. Проверьте консоль браузера

Откройте консоль разработчика (F12) и проверьте:
- **Network** вкладка: найдите запрос к `admin-ajax.php`
- Проверьте статус ответа (403, 500, и т.д.)
- Проверьте тело ответа - там должна быть детальная информация об ошибке

### 4. Используйте диагностический endpoint

В консоли браузера выполните:

```javascript
fetch(window.inssmartAjax.ajaxurl, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
        action: 'inssmart_diagnostic',
        nonce: window.inssmartAjax.nonce
    })
})
.then(r => r.json())
.then(console.log)
.catch(console.error);
```

Это покажет:
- Правильно ли создается nonce
- Правильно ли передается nonce
- Валиден ли nonce
- Другие параметры запроса

### 5. Возможные причины 403 ошибки

#### A. Проблема с nonce
**Симптомы:**
- В логах: `ОШИБКА NONCE`
- В ответе: `error_code: 'nonce_failed'`

**Решения:**
1. Обновите страницу (nonce может истечь)
2. Проверьте, что скрипт `inssmart-form.js` загружается
3. Проверьте, что `window.inssmartAjax` определен в консоли браузера

#### B. Проблема с правами доступа
**Симптомы:**
- Пользователь не авторизован, но форма требует авторизации

**Решения:**
1. Проверьте, что хук `wp_ajax_nopriv_inssmart_submit_order` зарегистрирован
2. Убедитесь, что форма доступна для неавторизованных пользователей

#### C. Проблема с сервером (mod_security, firewall)
**Симптомы:**
- 403 ошибка до того, как запрос доходит до WordPress
- Нет записей в логах WordPress

**Решения:**
1. Проверьте логи сервера (Apache/Nginx)
2. Временно отключите mod_security для тестирования
3. Проверьте настройки firewall

#### D. Проблема с CORS
**Симптомы:**
- Ошибка в консоли браузера о CORS
- Запрос не отправляется

**Решения:**
1. Убедитесь, что AJAX запрос идет на тот же домен
2. Проверьте настройки CORS на сервере

### 6. Проверка в коде

Убедитесь, что:
1. Скрипт `inssmart-form.js` загружается (проверьте в Network вкладке)
2. Объект `window.inssmartAjax` существует:
   ```javascript
   console.log(window.inssmartAjax);
   ```
3. Nonce передается в запросе:
   ```javascript
   console.log('Nonce:', window.inssmartAjax.nonce);
   ```

### 7. Временное отключение проверки nonce (только для отладки!)

**ВНИМАНИЕ:** Используйте только для диагностики! Никогда не оставляйте это в продакшене!

В файле `inssmart.php` временно закомментируйте проверку:

```php
// Временно отключено для отладки
// $nonce_check = check_ajax_referer('inssmart_ajax', 'nonce', false);
// if (!$nonce_check) { ... }

$nonce_check = true; // Временно всегда true
```

Если после этого форма работает, проблема точно в nonce.

### 8. Проверка версии nonce

Nonce в WordPress действителен 12-24 часа. Если страница открыта долго, nonce может истечь.

**Решение:** Обновите страницу перед отправкой формы.

## Контакты для поддержки

Если проблема не решается, соберите следующую информацию:
1. Вывод диагностического endpoint (шаг 4)
2. Релевантные строки из `wp-content/debug.log`
3. Скриншот консоли браузера с ошибкой
4. Версия WordPress
5. Версия плагина inssmart
6. Список активных плагинов




